# Phase 3.5 é·ç§»å¯¦éš›æƒ…æ³è©•ä¼°

**æ—¥æœŸ**: 2025-10-20  
**ç•¶å‰é€²åº¦**: 2/37 å‡½æ•¸å·²é·ç§»  
**é ä¼°å®Œæˆæ™‚é–“**: åŸä¼° 12-16h â†’ å¯¦éš›å¯èƒ½éœ€è¦ 20-25h

---

## åŸ·è¡Œæ‘˜è¦

åœ¨é–‹å§‹æ‰¹æ¬¡ 1 (Domain Layer) é·ç§»å¾Œ,ç™¼ç¾äº†å¹¾å€‹é—œéµå•é¡Œ,éœ€è¦é‡æ–°è©•ä¼°é·ç§»ç­–ç•¥ã€‚

### âœ… å·²å®Œæˆ

1. **domain/timing.py**: æˆåŠŸé·ç§» 2 å€‹ç°¡å–®å·¥å…·å‡½æ•¸
   - `_coerce_non_negative_float`
   - `_coerce_bool`
   - é€²åº¦: 2/37 (5%)

---

## ğŸš¨ ç™¼ç¾çš„é—œéµå•é¡Œ

### å•é¡Œ 1: è·è²¬åˆ†é¡éŒ¯èª¤

è¨±å¤šè¢«æ¨™è¨˜ç‚º "domain" çš„å‡½æ•¸å¯¦éš›ä¸ŠåŒ…å« infrastructure é‚è¼¯:

| å‡½æ•¸ | åŸè¨ˆåŠƒ | å¯¦éš›æ‡‰å±¬æ–¼ | åŸå›  |
|------|--------|-----------|------|
| `_plan_letter_images` | domain/layout.py | infrastructure/rendering/ | ä½¿ç”¨ PIL Image |
| `_apply_fadeout` | domain/effects.py | infrastructure/video/ | ä½¿ç”¨ MoviePy |
| `_apply_fadein` | domain/effects.py | infrastructure/video/ | ä½¿ç”¨ MoviePy |
| `_make_progress_bar_mask` | domain/effects.py | infrastructure/rendering/ | ä½¿ç”¨ numpy arrays |

**å½±éŸ¿**: éœ€è¦é‡æ–°ç”Ÿæˆ MIGRATION_MAPPING.json

---

### å•é¡Œ 2: å‡½æ•¸é–“é«˜åº¦è€¦åˆ

è¨±å¤šå‡½æ•¸æœ‰è¤‡é›œçš„ä¾è³´éˆ:

```
_plan_letter_images
  â”œâ”€ å‘¼å« _normalize_letters_sequence
  â”œâ”€ å‘¼å« _letter_asset_filename
  â”œâ”€ ä½¿ç”¨ PIL.Image
  â”œâ”€ ä½¿ç”¨ os.path
  â””â”€ ä½¿ç”¨ 5+ constants
```

**å½±éŸ¿**: ç„¡æ³•å–®ç¨é·ç§»,å¿…é ˆæ‰¹æ¬¡è™•ç†

---

### å•é¡Œ 3: éƒ¨åˆ†å‡½æ•¸éœ€è¦é‡æ§‹

æŸäº›å‡½æ•¸åŒæ™‚åŒ…å«å¤šç¨®è·è²¬:

```python
def _plan_letter_images(letters: str, asset_dir: str):
    # 1. ç´”é‚è¼¯: æ­£è¦åŒ–å­—æ¯åºåˆ— (domain)
    seq = _normalize_letters_sequence(letters)
    
    # 2. æª”æ¡ˆç³»çµ±: æª¢æŸ¥æª”æ¡ˆå­˜åœ¨ (infrastructure)
    if not os.path.isfile(path_str):
        ...
    
    # 3. PIL æ“ä½œ: è®€å–åœ–ç‰‡å°ºå¯¸ (infrastructure)
    with Image.open(path_str) as img:
        orig_w, orig_h = img.size
    
    # 4. ä½ˆå±€è¨ˆç®—: ç¸®æ”¾èˆ‡é–“è· (domain)
    base_scale = min(1.0, target_height / float(orig_h))
    ...
```

**å½±éŸ¿**: éœ€è¦å…ˆé‡æ§‹å‡½æ•¸,æ‹†åˆ†è·è²¬,æ‰èƒ½æ­£ç¢ºé·ç§»

---

## ğŸ“Š é‡æ–°è©•ä¼°çš„å·¥ä½œé‡

### åŸé ä¼° vs å¯¦éš›

| éšæ®µ | åŸé ä¼° | å¯¦éš›éœ€æ±‚ | åŸå›  |
|------|--------|---------|------|
| æ‰¹æ¬¡ 1 (Domain) | 4h | 8-10h | éœ€è¦é‡æ§‹ + é‡æ–°åˆ†é¡ |
| æ‰¹æ¬¡ 2 (Infrastructure) | 5h | 6-8h | éƒ¨åˆ†å·²åŒ…å«åœ¨æ‰¹æ¬¡ 1 |
| æ‰¹æ¬¡ 3 (Application) | 5h | 6-8h | ä¾è³´å‰å…©æ‰¹æ¬¡ |
| **ç¸½è¨ˆ** | 14h | **20-26h** | å¢åŠ  43-86% |

---

## ğŸ’¡ ä¿®æ­£å¾Œçš„åŸ·è¡Œç­–ç•¥

### ç­–ç•¥ A: æ¼¸é€²å¼é·ç§» (æ¨è–¦)

**åŸå‰‡**: åªé·ç§»è·è²¬æ˜ç¢ºã€ä¾è³´ç°¡å–®çš„å‡½æ•¸

**éšæ®µ 1**: ç°¡å–®å·¥å…·å‡½æ•¸ (å·²å®Œæˆ âœ…)
- `domain/timing.py`: 2 å€‹å‡½æ•¸
- æ™‚é–“: 30 åˆ†é˜

**éšæ®µ 2**: ç´”é‚è¼¯å‡½æ•¸ (ç„¡å¤–éƒ¨ä¾è³´)
- `_normalize_letters_sequence`
- `_letters_missing_names`
- `_letter_asset_filename`
- æ™‚é–“: 1h

**éšæ®µ 3**: é‡æ§‹è¤‡é›œå‡½æ•¸
- æ‹†åˆ† `_plan_letter_images` ç‚º domain + infrastructure
- æ™‚é–“: 3-4h

**éšæ®µ 4**: Infrastructure å‡½æ•¸
- PIL ç›¸é—œ â†’ `infrastructure/rendering/`
- MoviePy ç›¸é—œ â†’ `infrastructure/video/`
- æ™‚é–“: 4-5h

**ç¸½è¨ˆ**: 8.5-10.5h

---

### ç­–ç•¥ B: éƒ¨åˆ†é·ç§» + Re-export (å¿«é€Ÿæ–¹æ¡ˆ)

**åŸå‰‡**: åªé·ç§»æœ€é—œéµçš„ 10-15 å€‹å‡½æ•¸,å…¶é¤˜ä¿ç•™åœ¨ utils.py

**å„ªé»**:
- âœ… å¿«é€Ÿé”æˆ â‰¥95% ç¸®æ¸›ç›®æ¨™
- âœ… é™ä½é¢¨éšª
- âœ… ä¿æŒç³»çµ±ç©©å®š

**ç¼ºé»**:
- âš ï¸ æœªå®Œå…¨é”æˆã€Œå®Œå…¨ç§»é™¤èˆŠç¨‹å¼ç¢¼ã€ç›®æ¨™
- âš ï¸ utils.py ä»åŒ…å«éƒ¨åˆ†å¯¦ä½œ (ä½†å·²å¤§å¹…ç¸®æ¸›)

**æ™‚é–“**: 4-6h

---

### ç­–ç•¥ C: æš«åœé·ç§»,é‡æ–°è¦åŠƒ (ä¿å®ˆæ–¹æ¡ˆ)

**è¡Œå‹•**:
1. ä¿ç•™ç•¶å‰é€²åº¦ (2 å€‹å‡½æ•¸å·²é·ç§»)
2. é‡æ–°åˆ†æ 37 å€‹å‡½æ•¸çš„æ­£ç¢ºæ­¸å±¬
3. ç”Ÿæˆæ–°çš„ MIGRATION_MAPPING_V2.json
4. åˆ¶å®šæ›´è©³ç´°çš„é‡æ§‹è¨ˆåŠƒ

**æ™‚é–“**: è¦åŠƒ 2h + åŸ·è¡Œ 15-20h

---

## ğŸ¯ å»ºè­°æ±ºç­–

è€ƒæ…®åˆ°:
- åŸè¨ˆåŠƒç›®æ¨™: "å®Œå…¨ç§»é™¤èˆŠç¨‹å¼ç¢¼"
- å¯¦éš›ç™¼ç¾: è¨±å¤šå‡½æ•¸è·è²¬ä¸æ¸…,éœ€è¦é‡æ§‹
- æ™‚é–“æˆæœ¬: 20-26h vs åŸä¼° 14h

æˆ‘å»ºè­°æ¡ç”¨ **ç­–ç•¥ A (æ¼¸é€²å¼é·ç§»)**:

### ç«‹å³åŸ·è¡Œ (æ¥ä¸‹ä¾† 2-3h)

1. âœ… å®Œæˆéšæ®µ 2: é·ç§» 3 å€‹ç°¡å–®å‡½æ•¸
2. âœ… è©•ä¼°éšæ®µ 3 çš„é‡æ§‹éœ€æ±‚
3. âœ… æ±ºå®šæ˜¯å¦ç¹¼çºŒå…¨é‡é·ç§»

### å¾ŒçºŒé¸æ“‡

**é¸é … 1**: å¦‚æœéšæ®µ 2 é †åˆ© â†’ ç¹¼çºŒåŸ·è¡Œç­–ç•¥ A  
**é¸é … 2**: å¦‚æœç™¼ç¾æ›´å¤šå•é¡Œ â†’ æ”¹ç”¨ç­–ç•¥ B (éƒ¨åˆ†é·ç§»)  
**é¸é … 3**: å¦‚æœé¢¨éšªéé«˜ â†’ æ¡ç”¨ç­–ç•¥ C (æš«åœé‡è¦åŠƒ)

---

## ğŸ“‹ ç•¶å‰ç‹€æ…‹ç¸½çµ

### å·²å®Œæˆ
- âœ… Phase 3.1-3.4: ç’°å¢ƒã€TDDã€åˆ†æã€æ˜ å°„
- âœ… Phase 3.5 (2/37): `domain/timing.py` é·ç§»å®Œæˆ

### é€²è¡Œä¸­
- ğŸ”„ Phase 3.5 æ‰¹æ¬¡ 1: Domain Layer é·ç§» (2/13 å®Œæˆ)

### å¾…æ±ºç­–
- â“ æ¡ç”¨å“ªç¨®é·ç§»ç­–ç•¥ (A/B/C)
- â“ æ˜¯å¦é‡æ§‹è¤‡é›œå‡½æ•¸
- â“ æ˜¯å¦èª¿æ•´æœ€çµ‚ç›®æ¨™ (å®Œå…¨ç§»é™¤ vs å¤§å¹…ç¸®æ¸›)

---

## å»ºè­°çµ¦ç”¨æˆ¶çš„é¸æ“‡

**æ‚¨å¸Œæœ›**:

**A.** ç¹¼çºŒæ¼¸é€²å¼é·ç§» (ç­–ç•¥ A) - å…ˆå®Œæˆ 3 å€‹ç°¡å–®å‡½æ•¸,å†è©•ä¼°
**B.** æ¡ç”¨å¿«é€Ÿæ–¹æ¡ˆ (ç­–ç•¥ B) - éƒ¨åˆ†é·ç§» + re-export,å¿«é€Ÿé”æˆ â‰¥95% ç¸®æ¸›
**C.** æš«åœä¸¦é‡æ–°è¦åŠƒ (ç­–ç•¥ C) - æ›´è©³ç´°çš„åˆ†æèˆ‡é‡æ§‹è¨ˆåŠƒ

**D.** æ¥å—ç•¶å‰é€²åº¦ (2/37),ç›´æ¥é€²å…¥ Phase 3.6 å»ºç«‹ re-export å±¤

---

**æ™‚é–“çµ±è¨ˆ**:
- å·²æŠ•å…¥: ~2.5h (Phase 3.1-3.5 åˆæœŸ)
- ç­–ç•¥ A å‰©é¤˜: 8.5-10.5h
- ç­–ç•¥ B å‰©é¤˜: 4-6h
- ç­–ç•¥ D å‰©é¤˜: 2-3h (è·³è‡³ re-export)

